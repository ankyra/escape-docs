machine:
  services:
  - docker
  node:
    version: 6.1.0

dependencies:
  override:
  - wget https://github.com/gohugoio/hugo/releases/download/v0.22/hugo_0.22_Linux-64bit.deb
  - sudo dpkg -i hugo*.deb
  - npm install -g hugulp@1.3.0

  - curl https://storage.googleapis.com/escape-releases-eu/escape-v0.14.5.tgz > /home/ubuntu/bin/escape.tgz
  - tar -C /home/ubuntu/bin -xvzf /home/ubuntu/bin/escape.tgz

  - echo $GCLOUD_SERVICE_KEY | base64 --decode -i > key.json
  - escape deploy gcp-provider-latest -d 'gcp' -v credentials=@key.json
  - escape deploy ankyra/kubernetes-gce-latest -d 'gke' -v cluster_name=ci-cluster -v zone=europe-west1-d 
  cache_diretories:
  - /opt/circleci/nodejs/v4.2.6/lib/node_modules/

compile:
  override:
  - escape release -d "website" --skip-destroy -v docker_repository="eu.gcr.io/ankyra-ci/" -v 'docker_cmd=["gcloud", "docker", "--"]'

test:
  override:
  - echo "Already tested"


